<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel del Recepcionista | Car-King</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <h2>Panel del Recepcionista</h2>

  <div id="info"></div>
  <div id="plazasContainer">
    <!-- Plazas se cargan aquí -->
  </div>

  <button onclick="location.href='/recepcion/dashboard'">Ver Dashboard</button>
  <button id="verMapeo">Ver Mapeo de mi Cochera</button>

  <script>
    // Leer cocheraId guardada durante el login
    const cocheraId = sessionStorage.getItem('cocheraId');
    const info = document.getElementById('info');
    const plazasContainer = document.getElementById('plazasContainer');

    function renderPlazas(plazas) {
      plazasContainer.innerHTML = '';
      const list = document.createElement('div');
      list.className = 'plazas-list';
      plazas.forEach(p => {
        const item = document.createElement('div');
        item.className = 'plaza-item';
        item.innerHTML = `
          <span class="plaza-codigo">${p.codigo}</span>
          <span class="plaza-estado">${p.estado}</span>
          <button data-id="${p.id}" class="toggleBtn">${p.ocupada ? 'Marcar libre' : 'Marcar ocupada'}</button>
        `;
        list.appendChild(item);
      });
      plazasContainer.appendChild(list);

      // Añadir listeners
      document.querySelectorAll('.toggleBtn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          const nuevoEstado = !(btn.textContent.includes('libre'));
          fetch(`/api/plazas/${id}/estado?ocupada=${nuevoEstado}`, { method: 'POST' })
            .then(r => {
              if (r.ok) {
                // actualizar texto del botón y del estado
                btn.textContent = nuevoEstado ? 'Marcar libre' : 'Marcar ocupada';
                const estadoSpan = btn.parentElement.querySelector('.plaza-estado');
                estadoSpan.textContent = nuevoEstado ? 'OCUPADA' : 'LIBRE';
              } else {
                alert('Error actualizando plaza');
              }
            });
        });
      });
    }

    // Si no hay cochera seleccionada, asignar una cochera por defecto para evitar bucles
    const effectiveCocheraId = cocheraId || '1';
    if (!cocheraId) {
      // almacenar para futuras acciones en la sesión
      sessionStorage.setItem('cocheraId', effectiveCocheraId);
      info.innerHTML = `<p>No se detectó cochera seleccionada. Usando la <strong>Cochera ${effectiveCocheraId}</strong> por defecto para este demo.</p>`;
    } else {
      info.innerHTML = `<p>Estás operando en la <strong>Cochera ${cocheraId}</strong>.</p>`;
    }

    document.getElementById('verMapeo').addEventListener('click', () => {
      sessionStorage.setItem('cocheraId', effectiveCocheraId);
      window.location.href = '/conductor/mapeo';
    });

    // Cargar plazas desde la API (usa el endpoint que devuelve estados)
    fetch(`/api/cocheras/${effectiveCocheraId}/plazas`)
      .then(r => r.json())
      .then(data => renderPlazas(data))
      .catch(err => {
        plazasContainer.innerHTML = '<p>Error cargando plazas.</p>';
        console.error(err);
      });
  </script>
</body>
</html>
